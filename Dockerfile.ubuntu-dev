FROM ubuntu:24.04

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install essential packages and development tools
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    vim \
    neovim \
    build-essential \
    jq \
    ripgrep \
    fd-find \
    bat \
    htop \
    sudo \
    ca-certificates \
    gnupg \
    lsb-release \
    unzip \
    # Audio tools for notifications from container
    pulseaudio-utils \
    alsa-utils \
    sox \
    # GitHub CLI
    gh \
    # Browser automation (virtual display) - chromium installed separately via PPA
    xvfb \
    fonts-liberation \
    libnss3 \
    libxss1 \
    libasound2t64 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libdrm2 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxrandr2 \
    libgbm1 \
    libpango-1.0-0 \
    libcairo2 \
    # For add-apt-repository
    software-properties-common \
    # Dependencies for pyenv
    libbz2-dev \
    libffi-dev \
    liblzma-dev \
    libncurses5-dev \
    libncursesw5-dev \
    libreadline-dev \
    libsqlite3-dev \
    libssl-dev \
    llvm \
    tk-dev \
    xz-utils \
    zlib1g-dev \
    && rm -rf /var/lib/apt/lists/*

# Install Chromium from xtradeb PPA (supports arm64 and amd64, avoids snap issues in Docker)
RUN add-apt-repository -y ppa:xtradeb/apps && \
    apt-get update && \
    apt-get install -y chromium chromium-driver && \
    rm -rf /var/lib/apt/lists/*

# Install pyenv
ENV PYENV_ROOT=/opt/pyenv
ENV PATH=$PYENV_ROOT/bin:$PYENV_ROOT/shims:$PATH
RUN git clone --depth=1 https://github.com/pyenv/pyenv.git $PYENV_ROOT && \
    cd $PYENV_ROOT && \
    src/configure && \
    make -C src && \
    pyenv install 3.11 && \
    pyenv global 3.11

# Install commonly useful Python packages
RUN pip install --no-cache-dir \
    beautifulsoup4 \
    requests \
    numpy \
    pandas \
    scipy \
    matplotlib \
    seaborn \
    scikit-learn \
    pytest \
    python-dotenv \
    psycopg2-binary \
    SQLAlchemy \
    tqdm \
    colorama \
    psutil \
    lz4 \
    optuna \
    numba \
    fake-useragent \
    hrequests \
    websocket-client \
    playwright

# Install nvm and Node.js
ENV NVM_DIR=/opt/nvm
ENV NODE_VERSION=22
RUN mkdir -p $NVM_DIR && \
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash

# Install Node.js and global packages using nvm in a single RUN command
# Also create symlinks for global access
RUN bash -c "source $NVM_DIR/nvm.sh && \
    nvm install $NODE_VERSION && \
    nvm alias default $NODE_VERSION && \
    nvm use default && \
    npm install -g yarn && \
    npm install -g tsx && \
    npm install -g @openai/codex && \
    ln -s \$(which node) /usr/local/bin/node && \
    ln -s \$(which npm) /usr/local/bin/npm && \
    ln -s \$(which npx) /usr/local/bin/npx && \
    ln -s \$(which yarn) /usr/local/bin/yarn && \
    ln -s \$(which tsx) /usr/local/bin/tsx && \
    ln -s \$(which codex) /usr/local/bin/codex"

# Install Claude Code using native binary (latest version)
RUN curl -fsSL https://claude.ai/install.sh | bash -s latest && \
    ln -s /root/.local/bin/claude /usr/local/bin/claude
ENV PATH="/root/.local/bin:$PATH"

# Install Bun
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:$PATH"

# Install uv (fast pip replacement)
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:$PATH"

# Node memory limit for large codebases (prevents OOM crashes)
ENV NODE_OPTIONS="--max-old-space-size=4096"

# Install Playwright MCP server (used conditionally when ENABLE_BROWSER=1)
RUN bash -c "source $NVM_DIR/nvm.sh && npm install -g @playwright/mcp"

# Virtual display for browser automation
ENV DISPLAY=:99
ENV CHROME_CDP_PORT=9222
ENV CHROME_USER_DATA_DIR=/root/.chrome-profile
# Disable D-Bus to suppress Chromium warnings in headless mode
# (D-Bus is for desktop integration features not needed in containers)
# To enable D-Bus: install dbus package and run `eval $(dbus-launch)` before Chromium
ENV DBUS_SESSION_BUS_ADDRESS=/dev/null
ENV DBUS_SYSTEM_BUS_ADDRESS=/dev/null

# Create browser launch script
ENV CHROME_LOG_FILE=/var/log/chromium.log
RUN mkdir -p /root/.chrome-profile && \
    cat > /usr/local/bin/start-browser << 'BROWSEREOF'
#!/bin/bash
# Launch Chromium with CDP enabled for agent automation
# Logs written to $CHROME_LOG_FILE for debugging (default: /var/log/chromium.log)
LOG_FILE="${CHROME_LOG_FILE:-/var/log/chromium.log}"
chromium \
  --no-sandbox \
  --disable-gpu \
  --disable-dev-shm-usage \
  --disable-background-networking \
  --disable-default-apps \
  --disable-sync \
  --no-first-run \
  --remote-debugging-port=${CHROME_CDP_PORT:-9222} \
  --remote-allow-origins=* \
  --user-data-dir=${CHROME_USER_DATA_DIR:-/root/.chrome-profile} \
  --window-size=1920,1080 \
  "$@" >>"$LOG_FILE" 2>&1 &
echo "Chromium started with CDP on port ${CHROME_CDP_PORT:-9222}"
echo "Logs: $LOG_FILE"
BROWSEREOF
RUN chmod +x /usr/local/bin/start-browser

# Install dev-sessions-mcp
COPY dev-sessions/mcp /opt/dev-sessions-mcp
RUN bash -c "source $NVM_DIR/nvm.sh && \
    cd /opt/dev-sessions-mcp && \
    npm install && \
    npm run build && \
    npm install -g . && \
    ln -s \$(which dev-sessions-mcp) /usr/local/bin/dev-sessions-mcp"

# Configure git globally to handle ownership issues and set default credentials
RUN git config --system --add safe.directory '*' && \
    git config --system user.email "andrewtingnyc@gmail.com" && \
    git config --system user.name "Claude Ting"

# Create workspace directory
RUN mkdir -p /workspace

# Set up basic environment
RUN mkdir -p /root/.local/share/nvim && \
    mkdir -p /root/.claude && \
    mkdir -p /root/.codex

# Set sandbox environment variable
ENV IS_SANDBOX=1

# Create shell initialization script for pyenv and nvm
RUN echo '# Pyenv initialization' >> /etc/bash.bashrc && \
    echo 'export PYENV_ROOT=/opt/pyenv' >> /etc/bash.bashrc && \
    echo 'export PATH="$PYENV_ROOT/bin:$PYENV_ROOT/shims:$PATH"' >> /etc/bash.bashrc && \
    echo 'eval "$(pyenv init -)"' >> /etc/bash.bashrc && \
    echo '' >> /etc/bash.bashrc && \
    echo '# NVM initialization' >> /etc/bash.bashrc && \
    echo 'export NVM_DIR=/opt/nvm' >> /etc/bash.bashrc && \
    echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> /etc/bash.bashrc && \
    echo '[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"' >> /etc/bash.bashrc

# Create entrypoint script to merge OAuth credentials and MCP config
RUN cat > /entrypoint.sh << 'EOF'
#!/bin/bash

# Conditionally start browser automation (set ENABLE_BROWSER=1 to activate)
if [ "$ENABLE_BROWSER" = "1" ]; then
  if ! pgrep -x "Xvfb" > /dev/null; then
    echo "✓ Starting Xvfb on display :99"
    Xvfb :99 -screen 0 1920x1080x24 >>/var/log/xvfb.log 2>&1 &
    sleep 1
  fi

  # Start Chromium with CDP (uses start-browser script)
  start-browser
  sleep 2
fi

# Ensure the dev-sessions gateway hostname resolves from Docker
if [ -z "$DEV_SESSIONS_GATEWAY_URL" ]; then
  export DEV_SESSIONS_GATEWAY_URL="http://host.docker.internal:6767"
fi

# Merge Claude OAuth config from host file if available
if [ -f "/root/.claude.host.json" ]; then
  # Extract OAuth and user data from host config
  CONFIG_KEYS="oauthAccount hasSeenTasksHint userID hasCompletedOnboarding lastOnboardingVersion subscriptionNoticeCount hasAvailableSubscription s1mAccessCache mcpServers"

  # Build jq expression for extraction
  JQ_EXPR=""
  for key in $CONFIG_KEYS; do
    if [ -n "$JQ_EXPR" ]; then JQ_EXPR="$JQ_EXPR, "; fi
    JQ_EXPR="$JQ_EXPR\"$key\": .$key"
  done

  # Extract config data and add bypass permissions
  HOST_CONFIG=$(jq -c "{$JQ_EXPR, \"bypassPermissionsModeAccepted\": true}" /root/.claude.host.json 2>/dev/null || echo "")

  if [ -n "$HOST_CONFIG" ] && [ "$HOST_CONFIG" != "null" ] && [ "$HOST_CONFIG" != "{}" ]; then
    if [ -f "/root/.claude.json" ]; then
      # Merge with existing container file
      jq ". * $HOST_CONFIG" /root/.claude.json > /root/.claude.json.tmp && mv /root/.claude.json.tmp /root/.claude.json
      echo "✓ OAuth credentials merged from host"
    else
      # Create new container file with host config
      echo "$HOST_CONFIG" | jq . > /root/.claude.json
      echo "✓ OAuth credentials imported from host"
    fi
  fi
fi

# Skip MCP setup if DISABLE_MCPS=1 (for isolated agent loops)
if [ "$DISABLE_MCPS" = "1" ]; then
  echo "✓ MCP setup disabled (DISABLE_MCPS=1)"
  exec "$@"
fi

# Ensure dev-sessions MCP is configured in ~/.claude.json
if [ -f "/root/.claude.json" ]; then
  jq --arg gateway "$DEV_SESSIONS_GATEWAY_URL" --arg hostpath "${HOST_PATH:-}" \
     '.mcpServers = (.mcpServers // {}) |
      .mcpServers["dev-sessions"] = {
        "type": "stdio",
        "command": "dev-sessions-mcp",
        "args": [],
        "env": {
          "GATEWAY_URL": $gateway,
          "HOST_PATH": $hostpath
        }
      }' \
     /root/.claude.json > /root/.claude.json.tmp && mv /root/.claude.json.tmp /root/.claude.json
  echo "✓ Ensured dev-sessions MCP entry in ~/.claude.json"

  # Add Playwright MCP if browser is enabled
  if [ "$ENABLE_BROWSER" = "1" ]; then
    jq --arg cdp "http://localhost:${CHROME_CDP_PORT:-9222}" \
       '.mcpServers["playwright"] = {
          "type": "stdio",
          "command": "npx",
          "args": ["@playwright/mcp", "--cdp-endpoint", $cdp],
          "env": {}
        }' \
       /root/.claude.json > /root/.claude.json.tmp && mv /root/.claude.json.tmp /root/.claude.json
    echo "✓ Added Playwright MCP (connecting to CDP on port ${CHROME_CDP_PORT:-9222})"
  fi
fi

# Ensure MCP configuration exists (gets overwritten by mount)
if [ ! -f "/root/.claude/config.json" ]; then
  echo "✓ Creating MCP configuration"
  cat > /root/.claude/config.json << MCPEOF
{
  "mcpServers": {
    "dev-sessions": {
      "command": "dev-sessions-mcp",
      "env": {
        "GATEWAY_URL": "$DEV_SESSIONS_GATEWAY_URL",
        "HOST_PATH": "${HOST_PATH:-}"
      }
    }
  }
}
MCPEOF
else
  # MCP config exists, ensure dev-sessions is configured with HOST_PATH
  echo "✓ Updating dev-sessions MCP in existing config"
  jq --arg gateway "$DEV_SESSIONS_GATEWAY_URL" --arg hostpath "${HOST_PATH:-}" \
    '.mcpServers["dev-sessions"] = {"command": "dev-sessions-mcp", "env": {"GATEWAY_URL": $gateway, "HOST_PATH": $hostpath}}' \
    /root/.claude/config.json > /root/.claude/config.json.tmp && \
    mv /root/.claude/config.json.tmp /root/.claude/config.json
fi

# Add Playwright MCP to config.json if browser is enabled
if [ "$ENABLE_BROWSER" = "1" ] && [ -f "/root/.claude/config.json" ]; then
  jq --arg cdp "http://localhost:${CHROME_CDP_PORT:-9222}" \
     '.mcpServers["playwright"] = {
        "command": "npx",
        "args": ["@playwright/mcp", "--cdp-endpoint", $cdp]
      }' \
     /root/.claude/config.json > /root/.claude/config.json.tmp && \
     mv /root/.claude/config.json.tmp /root/.claude/config.json
  echo "✓ Added Playwright MCP to config.json"
fi

# Prepare Codex config in a shadow copy to avoid modifying host ~/.codex
ORIG_CODEX_HOME="${CODEX_HOME:-/root/.codex}"
# Keep this out of /tmp so Codex can install helper binaries without warnings.
SHADOW_CODEX_HOME="/root/.codex-shadow"
mkdir -p "$SHADOW_CODEX_HOME"
# Copy existing files for baseline (exclude history/sessions to avoid bind-mount conflicts)
if [ -d "$ORIG_CODEX_HOME" ] && [ "$(ls -A "$ORIG_CODEX_HOME" 2>/dev/null)" ]; then
  shopt -s dotglob nullglob
  for item in "$ORIG_CODEX_HOME"/*; do
    base="$(basename "$item")"
    if [ "$base" = "history.jsonl" ] || [ "$base" = "sessions" ]; then
      continue
    fi
    cp -a "$item" "$SHADOW_CODEX_HOME"/
  done
  shopt -u dotglob nullglob
fi
# Keep history and sessions persisted on host; symlink them into the shadow copy unless bind-mounted
mkdir -p "$ORIG_CODEX_HOME"
touch "$ORIG_CODEX_HOME/history.jsonl"
mkdir -p "$ORIG_CODEX_HOME/sessions"

is_mountpoint() {
  local target="$1"
  if command -v findmnt >/dev/null 2>&1; then
    local mp
    mp="$(findmnt -T "$target" -no TARGET 2>/dev/null || true)"
    [ "$mp" = "$target" ]
    return $?
  fi
  return 1
}

if is_mountpoint "$SHADOW_CODEX_HOME/history.jsonl"; then
  echo "✓ history.jsonl is bind-mounted; leaving as-is"
else
  ln -sf "$ORIG_CODEX_HOME/history.jsonl" "$SHADOW_CODEX_HOME/history.jsonl"
fi

if is_mountpoint "$SHADOW_CODEX_HOME/sessions"; then
  echo "✓ sessions is bind-mounted; leaving as-is"
else
  ln -snf "$ORIG_CODEX_HOME/sessions" "$SHADOW_CODEX_HOME/sessions"
fi

export CODEX_HOME="$SHADOW_CODEX_HOME"
CODEX_CONFIG="$CODEX_HOME/config.toml"
export CODEX_CONFIG

if [ ! -f "$CODEX_CONFIG" ]; then
  cat > "$CODEX_CONFIG" << CODEXEOF
tool_output_token_limit = 25000
web_search = "live"

[mcp_servers."dev-sessions"]
command = "dev-sessions-mcp"

[mcp_servers."dev-sessions".env]
GATEWAY_URL = "$DEV_SESSIONS_GATEWAY_URL"
HOST_PATH = "${HOST_PATH:-}"
CODEXEOF
  echo "✓ Created Codex config with dev-sessions MCP entry (shadow copy)"
else
  # Ensure dev-sessions config is correct inside the shadow copy
  export DEV_GATEWAY="$DEV_SESSIONS_GATEWAY_URL"
  export DEV_HOST_PATH="${HOST_PATH:-}"
  python - <<'PY'
import os, re, pathlib

config_path = os.environ["CODEX_CONFIG"]
gateway = os.environ["DEV_GATEWAY"]
host_path = os.environ.get("DEV_HOST_PATH", "")

text = pathlib.Path(config_path).read_text(encoding="utf-8")

if '[mcp_servers."dev-sessions"]' not in text:
    text += f'\n[mcp_servers."dev-sessions"]\ncommand = "dev-sessions-mcp"\n'

if '[mcp_servers."dev-sessions".env]' not in text:
    text += f'\n[mcp_servers."dev-sessions".env]\nGATEWAY_URL = "{gateway}"\nHOST_PATH = "{host_path}"\n'
else:
    pattern = r'(\[mcp_servers\."dev-sessions"\.env\][^\[]*)'
    def repl(match):
        block = match.group(1)
        # Update or add GATEWAY_URL
        if "GATEWAY_URL" in block:
            block = re.sub(r'GATEWAY_URL\s*=.*', f'GATEWAY_URL = "{gateway}"', block)
        else:
            block = block.rstrip() + f'\nGATEWAY_URL = "{gateway}"\n'
        # Update or add HOST_PATH
        if "HOST_PATH" in block:
            block = re.sub(r'HOST_PATH\s*=.*', f'HOST_PATH = "{host_path}"', block)
        else:
            block = block.rstrip() + f'\nHOST_PATH = "{host_path}"\n'
        return block
    text = re.sub(pattern, repl, text, count=1, flags=re.S)

pathlib.Path(config_path).write_text(text, encoding="utf-8")
PY
  echo "✓ Updated dev-sessions config in Codex config shadow copy"
fi

# Execute the command
exec "$@"
EOF

RUN chmod +x /entrypoint.sh

WORKDIR /workspace

ENTRYPOINT ["/entrypoint.sh"]
CMD ["/bin/bash"]
